<!DOCTYPE html>
<html lang="zh" dir="ltr">
<head>
	<meta name="generator" content="Hugo 0.136.0"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="
  二进制安装 K8s：中文版
  #


  目录
  #


前言
一、基本信息和服务器准备
二、K8s 的证书
三、安装 Master 节点
四、安装 Worker 节点
五、设置基本的路由网络
六、运行Pod


  前言
  #

这是我在学习二进制安装 K8s 时候做的笔记，我装的是 1 个 Master 和 2 个 Node。安装的时候没用脚本，也没有 HA。
这个笔记适合：

用来培养自己对于 K8s 各个组件的感性理解
用来安装一个极简环境

不适合：

不适合用来部署生产环境
学习一些比较进阶的概念

如无意外，这份笔记每年会更新两次。

  版本说明
  #

现在这份文档主要编写于 2024 年 9 到 10 月份，下面是主要使用的软件版本。
OS: Rocky Linux 8.10
组件的版本:

  
      
          组件
          版本
      
  
  
      
          Kubernetes
          v1.31.1
      
      
          etcd
          v3.4.34
      
      
          containerd
          v1.7.22
      
  


  参考
  #

这份笔记参考了下面的材料：

《Kubernetes 权威指南》
kelseyhightower/kubernetes-the-hard-way


  三、安装 Master 节点
  #

在 Master 节点上，我们要安装 etcd，kube-apiserver，kube-controller-manager 和 kube-scheduler 四个服务。">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/zh/">
  <meta property="og:site_name" content="Install Kubernetes from binaries">
  <meta property="og:title" content="首页">
  <meta property="og:description" content="二进制安装 K8s：中文版 # 目录 # 前言 一、基本信息和服务器准备 二、K8s 的证书 三、安装 Master 节点 四、安装 Worker 节点 五、设置基本的路由网络 六、运行Pod 前言 # 这是我在学习二进制安装 K8s 时候做的笔记，我装的是 1 个 Master 和 2 个 Node。安装的时候没用脚本，也没有 HA。
这个笔记适合：
用来培养自己对于 K8s 各个组件的感性理解 用来安装一个极简环境 不适合：
不适合用来部署生产环境 学习一些比较进阶的概念 如无意外，这份笔记每年会更新两次。
版本说明 # 现在这份文档主要编写于 2024 年 9 到 10 月份，下面是主要使用的软件版本。
OS: Rocky Linux 8.10
组件的版本:
组件 版本 Kubernetes v1.31.1 etcd v3.4.34 containerd v1.7.22 参考 # 这份笔记参考了下面的材料：
《Kubernetes 权威指南》 kelseyhightower/kubernetes-the-hard-way 三、安装 Master 节点 # 在 Master 节点上，我们要安装 etcd，kube-apiserver，kube-controller-manager 和 kube-scheduler 四个服务。">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="website">
<title>首页 | Install Kubernetes from binaries</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="http://localhost:1313/zh/">
  <link rel="alternate" hreflang="en" href="http://localhost:1313/" title="Install Kubernetes from binaries">
<link rel="stylesheet" href="/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css" integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin="anonymous">
  <script defer src="/fuse.min.js"></script>
  <script defer src="/zh.search.min.509cc74ce206b987f7c45f3959c96b65a53156e5462a6602a8bdbabac548b1c6.js" integrity="sha256-UJzHTOIGuYf3xF85WclrZaUxVuVGKmYCqL26usVIscY=" crossorigin="anonymous"></script>
<link rel="alternate" type="application/rss+xml" href="http://localhost:1313/zh/index.xml" title="Install Kubernetes from binaries" />
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/zh/"><span>Install Kubernetes from binaries</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="搜索" aria-label="搜索" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>



  



  
    
  


  


<ul class="book-languages">
  <li>
    <input type="checkbox" id="languages" class="toggle" />
    <label for="languages" class="flex justify-between">
      <a role="button" class="flex align-center">
        <img src="/svg/translate.svg" class="book-icon" alt="Languages" />
        Chinese
      </a>
    </label>

    <ul>
      
      <li>
        <a href="/">
          English
        </a>
      </li>
      
    </ul>
  </li>
</ul>














  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <a href="/zh/docs/getting-started/" class="">基础部分</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/zh/docs/getting-started/basic-info-and-server-preparation/" class="">一、基本信息和服务器准备</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/zh/docs/getting-started/certificates-and-keys/" class="">二、K8s 的证书和 Key</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>进阶部分</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/zh/docs/advanced/buttons/" class="">Buttons</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/zh/docs/advanced/columns/" class="">Columns</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/zh/docs/advanced/details/" class="">Details</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/zh/docs/advanced/hints/" class="">Hints</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/zh/docs/advanced/mermaid/" class="">Mermaid</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/zh/docs/advanced/tabs/" class="">Tabs</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/zh/docs/advanced/katex/" class="">KaTeX</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>














</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>首页</h3>

  <label for="toc-control">
    
  </label>
</div>


  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="二进制安装-k8s中文版">
  二进制安装 K8s：中文版
  <a class="anchor" href="#%e4%ba%8c%e8%bf%9b%e5%88%b6%e5%ae%89%e8%a3%85-k8s%e4%b8%ad%e6%96%87%e7%89%88">#</a>
</h1>
<h2 id="目录">
  目录
  <a class="anchor" href="#%e7%9b%ae%e5%bd%95">#</a>
</h2>
<ul>
<li>前言</li>
<li>一、基本信息和服务器准备</li>
<li>二、K8s 的证书</li>
<li>三、安装 Master 节点</li>
<li>四、安装 Worker 节点</li>
<li>五、设置基本的路由网络</li>
<li>六、运行Pod</li>
</ul>
<h2 id="前言">
  前言
  <a class="anchor" href="#%e5%89%8d%e8%a8%80">#</a>
</h2>
<p>这是我在学习二进制安装 K8s 时候做的笔记，我装的是 1 个 Master 和 2 个 Node。安装的时候没用脚本，也没有 HA。</p>
<p>这个笔记适合：</p>
<ul>
<li>用来培养自己对于 K8s 各个组件的感性理解</li>
<li>用来安装一个极简环境</li>
</ul>
<p>不适合：</p>
<ul>
<li>不适合用来部署生产环境</li>
<li>学习一些比较进阶的概念</li>
</ul>
<p>如无意外，这份笔记每年会更新两次。</p>
<h3 id="版本说明">
  版本说明
  <a class="anchor" href="#%e7%89%88%e6%9c%ac%e8%af%b4%e6%98%8e">#</a>
</h3>
<p>现在这份文档主要编写于 2024 年 9 到 10 月份，下面是主要使用的软件版本。</p>
<p>OS: Rocky Linux 8.10</p>
<p>组件的版本:</p>
<table>
  <thead>
      <tr>
          <th>组件</th>
          <th>版本</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Kubernetes</td>
          <td>v1.31.1</td>
      </tr>
      <tr>
          <td>etcd</td>
          <td>v3.4.34</td>
      </tr>
      <tr>
          <td>containerd</td>
          <td>v1.7.22</td>
      </tr>
  </tbody>
</table>
<h3 id="参考">
  参考
  <a class="anchor" href="#%e5%8f%82%e8%80%83">#</a>
</h3>
<p>这份笔记参考了下面的材料：</p>
<ul>
<li><a href="https://book.douban.com/subject/35458432/">《Kubernetes 权威指南》</a></li>
<li><a href="https://github.com/kelseyhightower/kubernetes-the-hard-way">kelseyhightower/kubernetes-the-hard-way</a></li>
</ul>
<h2 id="三安装-master-节点">
  三、安装 Master 节点
  <a class="anchor" href="#%e4%b8%89%e5%ae%89%e8%a3%85-master-%e8%8a%82%e7%82%b9">#</a>
</h2>
<p>在 Master 节点上，我们要安装 <code>etcd</code>，<code>kube-apiserver</code>，<code>kube-controller-manager</code> 和 <code>kube-scheduler</code> 四个服务。</p>
<p>另外，还要安装 <code>etcdctl</code> 和 <code>kubectl</code> 这两个工具，分别用来管理 etcd 和 K8s。</p>
<p>这些全是二进制可执行的文件，我们把他们都放在 <code>/usr/local/bin</code> 里面。</p>
<p>如果前面还没做过的话，现在可以在 <code>~/.bash_profile</code> 文件中把 <code>/usr/local/bin</code> 加到 PATH 里。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;export PATH=</span>$PATH<span style="color:#e6db74">:/usr/local/bin&#34;</span> &gt;&gt; ~/.bash_profile
</span></span><span style="display:flex;"><span>source ~/.bash_profile
</span></span></code></pre></div><h3 id="下载">
  下载
  <a class="anchor" href="#%e4%b8%8b%e8%bd%bd">#</a>
</h3>
<p><strong>etcd</strong></p>
<p>etcd 可以在这里下载：</p>
<p><a href="https://github.com/etcd-io/etcd/releases/">https://github.com/etcd-io/etcd/releases/</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/etcd-io/etcd/releases/download/v3.4.34/etcd-v3.4.34-linux-amd64.tar.gz
</span></span></code></pre></div><p>解压出来，里面有 <code>etcd</code> 和 <code>etcdctl</code>。把他们都放在 <code>/usr/local/bin</code> 里。</p>
<p><strong>Kubernetes 的组件</strong></p>
<p>Kubernetes 的二进制文件可以在这里下载：</p>
<p><a href="https://kubernetes.io/releases/download/#binaries">https://kubernetes.io/releases/download/#binaries</a></p>
<p>我们把 <code>kube-apiserver</code>，<code>kube-controller-manager</code>，<code>kube-scheduler</code> 和 <code>kubectl</code> 下载下来，也都放在 <code>/usr/local/bin</code> 里面。</p>
<p>至此，在 <code>/usr/local/bin</code> 里面一共有 8 个文件（前一个章节还有 2 个 cfssl 的工具放在这里了）。调整一下他们的权限。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chown root.root /usr/local/bin/*
</span></span><span style="display:flex;"><span>chmod +x /usr/local/bin/*
</span></span></code></pre></div><h3 id="配置-etcd">
  配置 etcd
  <a class="anchor" href="#%e9%85%8d%e7%bd%ae-etcd">#</a>
</h3>
<p>给 etcd 创建一个存放数据的文件夹。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /var/lib/etcd
</span></span></code></pre></div><p>创建 /etc/systemd/system/etcd.service，写下面的配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[Unit]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">etcd key-value store</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Documentation</span><span style="color:#f92672">=</span><span style="color:#e6db74">https://github.com/etcd-io/etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">After</span><span style="color:#f92672">=</span><span style="color:#e6db74">network.target</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Service]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Type</span><span style="color:#f92672">=</span><span style="color:#e6db74">notify</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/usr/local/bin/etcd --name master \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--data-dir /var/lib/etcd \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--listen-client-urls http://0.0.0.0:2379 \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--advertise-client-urls http://0.0.0.0:2379 \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--listen-peer-urls http://0.0.0.0:2380 \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--initial-advertise-peer-urls http://0.0.0.0:2380 \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--initial-cluster master</span><span style="color:#f92672">=</span><span style="color:#e6db74">http://0.0.0.0:2380 \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--initial-cluster-token etcd-cluster-0 \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--initial-cluster-state new</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Restart</span><span style="color:#f92672">=</span><span style="color:#e6db74">always</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RestartSec</span><span style="color:#f92672">=</span><span style="color:#e6db74">5</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LimitNOFILE</span><span style="color:#f92672">=</span><span style="color:#e6db74">65536</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Install]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">multi-user.target</span>
</span></span></code></pre></div><p>上面这个配置启动了一个单节点的 etcd，开放了所有端口，并且没有设置身份认证。<strong>不要在生产环境这样做。</strong></p>
<p>启动 etcd，并且将其设置为随机器启动。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl start etcd
</span></span><span style="display:flex;"><span>systemctl enable etcd
</span></span></code></pre></div><h3 id="配置-kube-apiserver">
  配置 kube-apiserver
  <a class="anchor" href="#%e9%85%8d%e7%bd%ae-kube-apiserver">#</a>
</h3>
<p>创建 <code>/etc/systemd/system/kube-apiserver.service</code>，写下面的配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[Unit]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">Kubernetes API Server</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Documentation</span><span style="color:#f92672">=</span><span style="color:#e6db74">https://github.com/kubernetes/kubernetes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Service]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EnvironmentFile</span><span style="color:#f92672">=</span><span style="color:#e6db74">/etc/kubernetes/kube-apiserver.env</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/usr/local/bin/kube-apiserver $KUBE_APISERVER_ARGS</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Restart</span><span style="color:#f92672">=</span><span style="color:#e6db74">on-failure</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RestartSec</span><span style="color:#f92672">=</span><span style="color:#e6db74">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Install]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">multi-user.target</span>
</span></span></code></pre></div><p>创建 <code>/etc/kubernetes/kube-apiserver.env</code>，写下面这些启动参数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">KUBE_APISERVER_ARGS</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--allow-privileged=true \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--apiserver-count</span><span style="color:#f92672">=</span><span style="color:#e6db74">1 \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--authorization-mode</span><span style="color:#f92672">=</span><span style="color:#e6db74">Node,RBAC \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--bind-address</span><span style="color:#f92672">=</span><span style="color:#e6db74">192.168.56.10 \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--client-ca-file</span><span style="color:#f92672">=</span><span style="color:#e6db74">/etc/kubernetes/pki/ca.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--enable-admission-plugins</span><span style="color:#f92672">=</span><span style="color:#e6db74">NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--etcd-servers</span><span style="color:#f92672">=</span><span style="color:#e6db74">http://127.0.0.1:2379 \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--event-ttl</span><span style="color:#f92672">=</span><span style="color:#e6db74">1h \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--runtime-config</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;api/all=true&#39; \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--service-account-key-file</span><span style="color:#f92672">=</span><span style="color:#e6db74">/etc/kubernetes/pki/sa-pub.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--service-account-signing-key-file</span><span style="color:#f92672">=</span><span style="color:#e6db74">/etc/kubernetes/pki/sa-key.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--service-account-issuer</span><span style="color:#f92672">=</span><span style="color:#e6db74">https://master:6443 \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--service-cluster-ip-range</span><span style="color:#f92672">=</span><span style="color:#e6db74">10.96.0.0/24 \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--tls-cert-file</span><span style="color:#f92672">=</span><span style="color:#e6db74">/etc/kubernetes/pki/kube-apiserver.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--tls-private-key-file</span><span style="color:#f92672">=</span><span style="color:#e6db74">/etc/kubernetes/pki/kube-apiserver-key.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--v</span><span style="color:#f92672">=</span><span style="color:#e6db74">2&#34;</span>
</span></span></code></pre></div><p>这些配置指定了 <code>kube-apiserver</code> 的认证方式、各种证书的位置、使用的 etcd 地址，还有 Service 网段（service-cluster-ip-range）等等信息。</p>
<p>启动并设置开机自动启动。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl start kube-apiserver
</span></span><span style="display:flex;"><span>systemctl enable kube-apiserver
</span></span></code></pre></div><h3 id="配置-kubeconfig">
  配置 kubeconfig
  <a class="anchor" href="#%e9%85%8d%e7%bd%ae-kubeconfig">#</a>
</h3>
<p>接下来我们要准备一份 <code>kubeconfig</code>，如前所述，这个文件是打开 Kubernetes API 的钥匙。</p>
<p>创建 <code>/etc/kubernetes/admin.kubeconfig</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Config</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clusters</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">cluster</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">certificate-authority</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.pem</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">server</span>: <span style="color:#ae81ff">https://master:6443</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubernetes</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">users</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">admin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">user</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">client-certificate</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/client.pem</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">client-key</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/client-key.pem</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">contexts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">context</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cluster</span>: <span style="color:#ae81ff">kubernetes</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">user</span>: <span style="color:#ae81ff">admin</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">admin@kubernetes</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">current-context</span>: <span style="color:#ae81ff">admin@kubernetes</span>
</span></span></code></pre></div><p>这里面指定了 API 的访问地址、CA 证书，以及我们做为客户端要使用的 client 证书/Key。</p>
<p>在 <code>~/.bash_profile</code> 里面添加上这个 <code>kubeconfig</code> 的环境变量，这样一来，我们的 <code>kubectl</code> 就知道要用这个了 config 了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;export KUBECONFIG=/etc/kubernetes/admin.kubeconfig&#34;</span> &gt;&gt; ~/.bash_profile
</span></span><span style="display:flex;"><span>source ~/.bash_profile
</span></span></code></pre></div><p>现在我们可以测试一下 <code>kubectl</code> 和 <code>kube-apiserver</code> 的连通性，执行下面的命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl version
</span></span></code></pre></div><p>如果能看到 <code>Server Version</code>，则说明 <code>kubectl</code> 到 <code>kube-apiserver</code> 都通了，前面的证书生成和配置都没什么问题。</p>
<p>如果没有看到 <code>Server Version</code>，应该停下来，把前面的步骤再检查一下。</p>
<h3 id="配置-kube-controller-manager">
  配置 kube-controller-manager
  <a class="anchor" href="#%e9%85%8d%e7%bd%ae-kube-controller-manager">#</a>
</h3>
<p>创建 <code>/etc/systemd/system/kube-controller-manager.service</code>，写下面的配置。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[Unit]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">Kubernetes Controller Manager</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Documentation</span><span style="color:#f92672">=</span><span style="color:#e6db74">https://github.com/kubernetes/kubernetes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Service]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EnvironmentFile</span><span style="color:#f92672">=</span><span style="color:#e6db74">/etc/kubernetes/kube-controller-manager.env</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/usr/local/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_ARGS</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Restart</span><span style="color:#f92672">=</span><span style="color:#e6db74">on-failure</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RestartSec</span><span style="color:#f92672">=</span><span style="color:#e6db74">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Install]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">multi-user.target</span>
</span></span></code></pre></div><p>创建 <code>/etc/kubernetes/kube-controller-manager.env</code>，写下面这些启动参数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">KUBE_CONTROLLER_MANAGER_ARGS</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--bind-address=192.168.56.10 \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--cluster-cidr</span><span style="color:#f92672">=</span><span style="color:#e6db74">10.244.0.0/16 \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--cluster-name</span><span style="color:#f92672">=</span><span style="color:#e6db74">kubernetes \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--cluster-signing-cert-file</span><span style="color:#f92672">=</span><span style="color:#e6db74">/etc/kubernetes/pki/ca.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--cluster-signing-key-file</span><span style="color:#f92672">=</span><span style="color:#e6db74">/etc/kubernetes/pki/ca-key.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--kubeconfig</span><span style="color:#f92672">=</span><span style="color:#e6db74">/etc/kubernetes/admin.kubeconfig \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--root-ca-file</span><span style="color:#f92672">=</span><span style="color:#e6db74">/etc/kubernetes/pki/ca.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--service-account-private-key-file</span><span style="color:#f92672">=</span><span style="color:#e6db74">/etc/kubernetes/pki/sa-key.pem \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--service-cluster-ip-range</span><span style="color:#f92672">=</span><span style="color:#e6db74">10.96.0.0/24 \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--use-service-account-credentials</span><span style="color:#f92672">=</span><span style="color:#e6db74">true \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--v</span><span style="color:#f92672">=</span><span style="color:#e6db74">2&#34;</span>
</span></span></code></pre></div><p>这些配置指定了集群的 Pod 的地址段、Service 的地址段，证书位置，kubeconfig 位置等等。</p>
<p>启动并设置开机自动启动。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl start kube-controller-manager
</span></span><span style="display:flex;"><span>systemctl enable kube-controller-manager
</span></span></code></pre></div><h3 id="配置-kube-scheduler">
  配置 kube-scheduler
  <a class="anchor" href="#%e9%85%8d%e7%bd%ae-kube-scheduler">#</a>
</h3>
<p>创建 <code>/etc/systemd/system/kube-scheduler.service</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[Unit]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">Kubernetes Scheduler</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Documentation</span><span style="color:#f92672">=</span><span style="color:#e6db74">https://github.com/kubernetes/kubernetes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Service]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EnvironmentFile</span><span style="color:#f92672">=</span><span style="color:#e6db74">/etc/kubernetes/kube-scheduler.env</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/usr/local/bin/kube-scheduler $KUBE_SCHEDULER_ARGS</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Restart</span><span style="color:#f92672">=</span><span style="color:#e6db74">on-failure</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RestartSec</span><span style="color:#f92672">=</span><span style="color:#e6db74">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Install]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">multi-user.target</span>
</span></span></code></pre></div><p>创建 <code>/etc/kubernetes/kube-scheduler.env</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">KUBE_SCHEDULER_ARGS</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--kubeconfig=/etc/kubernetes/admin.kubeconfig \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--leader-elect</span><span style="color:#f92672">=</span><span style="color:#e6db74">true \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--v</span><span style="color:#f92672">=</span><span style="color:#e6db74">0&#34;</span>
</span></span></code></pre></div><p>scheduler 基本上只要能连接到 API Server 就可以，所以这里的配置比较简单。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl start kube-scheduler
</span></span><span style="display:flex;"><span>systemctl enable kube-scheduler
</span></span></code></pre></div><p>接下来，我们<a href="/cn/04-%e5%ae%89%e8%a3%85Worker%e8%8a%82%e7%82%b9.md">安装 Worker 节点</a>。</p>
<h2 id="四安装-worker-节点">
  四、安装 Worker 节点
  <a class="anchor" href="#%e5%9b%9b%e5%ae%89%e8%a3%85-worker-%e8%8a%82%e7%82%b9">#</a>
</h2>
<p>接下来我们安装 Worker 节点，主要是安装 <code>kubelet</code>，容器的 Runtime，还有准备网络工具，也就是所谓的 CNI Plugins。</p>
<p>这部分的操作要在两个 Node 服务器上分别执行。</p>
<p>Worker 的多数二进制的文件，我们也都都放在 <code>/usr/local/bin</code> 里面，并且可以在 <code>~/.bash_profile</code> 里面把 <code>/usr/local/bin</code> 加到 <code>PATH</code> 里。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /usr/local/bin
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;export PATH=</span>$PATH<span style="color:#e6db74">:/usr/local/bin&#34;</span> &gt;&gt; ~/.bash_profile
</span></span><span style="display:flex;"><span>source ~/.bash_profile
</span></span></code></pre></div><h3 id="安装容器-runtime">
  安装容器 Runtime
  <a class="anchor" href="#%e5%ae%89%e8%a3%85%e5%ae%b9%e5%99%a8-runtime">#</a>
</h3>
<p>在 Worker 节点上，调用的链条主要是下面这样：kubelet 指挥 containerd，containerd 指挥 runc，其中 containerd 和 runc 共同构成容器的运行环境。</p>
<pre tabindex="0"><code>┌───────────┐       ┌──────────────┐       ┌────────┐
│           │       │              │       │        │
│  kubelet  ┼──────►│  containerd  ┼──────►│  runc  │
│           │       │              │       │        │
└───────────┘       └──────────────┘       └────────┘
</code></pre><p>我们第一步安装 containerd。</p>
<blockquote>
<p>[!NOTE]
containerd 官方提供了一个非常好的<a href="https://github.com/containerd/containerd/blob/main/docs/getting-started.md">安装说明</a>，推荐阅读。</p>
</blockquote>
<p>首先下载 containerd 的文件包，把里面东西都解压到 <code>/usr/local/bin</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/containerd/containerd/releases/download/v1.7.22/containerd-1.7.22-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar Cxzvf /usr/local containerd-1.7.22-linux-amd64.tar.gz
</span></span></code></pre></div><p>然后可以下载 containerd.service 文件，官方帮忙准备好了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd /etc/systemd/system/
</span></span><span style="display:flex;"><span>wget https://raw.githubusercontent.com/containerd/containerd/main/containerd.service
</span></span></code></pre></div><p>创建 containerd 的配置文件 <code>/etc/containerd/config.toml</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#a6e22e">version</span> = <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>]
</span></span><span style="display:flex;"><span>  [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style="color:#a6e22e">containerd</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">snapshotter</span> = <span style="color:#e6db74">&#34;overlayfs&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">default_runtime_name</span> = <span style="color:#e6db74">&#34;runc&#34;</span>
</span></span><span style="display:flex;"><span>  [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style="color:#a6e22e">containerd</span>.<span style="color:#a6e22e">runtimes</span>.<span style="color:#a6e22e">runc</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">runtime_type</span> = <span style="color:#e6db74">&#34;io.containerd.runc.v2&#34;</span>
</span></span><span style="display:flex;"><span>  [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style="color:#a6e22e">containerd</span>.<span style="color:#a6e22e">runtimes</span>.<span style="color:#a6e22e">runc</span>.<span style="color:#a6e22e">options</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">SystemdCgroup</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style="color:#a6e22e">cni</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bin_dir</span> = <span style="color:#e6db74">&#34;/opt/cni/bin&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">conf_dir</span> = <span style="color:#e6db74">&#34;/etc/cni/net.d&#34;</span>
</span></span></code></pre></div><p>启动 containerd，设置开机启动。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl start containerd
</span></span><span style="display:flex;"><span>systemctl enable containerd
</span></span></code></pre></div><p>然后下载 runc，放在 <code>/usr/local/bin</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd /usr/local/bin
</span></span><span style="display:flex;"><span>wget https://github.com/opencontainers/runc/releases/download/v1.1.14/runc.amd64
</span></span><span style="display:flex;"><span>mv runc.amd64 runc
</span></span><span style="display:flex;"><span>chmod +x runc
</span></span></code></pre></div><p>runc 不用启动，放在这里就行。</p>
<p>然后下载网络插件 CNI Plugins，放在 <code>/opt/cni/bin</code>，注意这个路径和我们前面用的都不一样，是约定俗成放在这里。</p>
<p>网络的配置在后面的章节。现在做到这些就可以。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p /opt/cni/bin
</span></span><span style="display:flex;"><span>wget https://github.com/containernetworking/plugins/releases/download/v1.5.1/cni-plugins-linux-amd64-v1.5.1.tgz
</span></span><span style="display:flex;"><span>tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.5.1.tgz
</span></span></code></pre></div><p>到这里，容器 Runtime 的部分就算安装完成了。</p>
<h3 id="安装-kubelet">
  安装 Kubelet
  <a class="anchor" href="#%e5%ae%89%e8%a3%85-kubelet">#</a>
</h3>
<p>下载 <code>kubelet</code>，放在 <code>/usr/local/bin</code>。</p>
<pre tabindex="0"><code>cd /usr/local/bin
wget https://dl.k8s.io/v1.31.1/bin/linux/amd64/kubelet
chmod +x kubelet
</code></pre><p>Node 节点的 Kubernetes 配置文件和证书，我们也都放在 <code>/etc/kubernetes</code> 文件夹。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /etc/kubernetes
</span></span><span style="display:flex;"><span>mkdir /etc/kubernetes/pki
</span></span></code></pre></div><p>把 Master 节点的 kubeconfig、CA 证书和 Key，以及 client 的证书和 Key 都复制到 Node 节点。下面这个在 Master 节点执行。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># node01</span>
</span></span><span style="display:flex;"><span>scp /etc/kubernetes/admin.kubeconfig root@node01:/etc/kubernetes
</span></span><span style="display:flex;"><span>scp /etc/kubernetes/pki/ca* root@node01:/etc/kubernetes/pki
</span></span><span style="display:flex;"><span>scp /etc/kubernetes/pki/client* root@node01:/etc/kubernetes/pki
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># node02</span>
</span></span><span style="display:flex;"><span>scp /etc/kubernetes/admin.kubeconfig root@node02:/etc/kubernetes
</span></span><span style="display:flex;"><span>scp /etc/kubernetes/pki/ca* root@node02:/etc/kubernetes/pki
</span></span><span style="display:flex;"><span>scp /etc/kubernetes/pki/client* root@node02:/etc/kubernetes/pki
</span></span></code></pre></div><p>准备 kubelet 的配置文件 <code>/etc/kubernetes/kubelet.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">KubeletConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubelet.config.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">authentication</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">anonymous</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">webhook</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">x509</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">clientCAFile</span>: <span style="color:#e6db74">&#34;/etc/kubernetes/pki/ca.pem&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">serverTLSBootstrap</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">port</span>: <span style="color:#ae81ff">10250</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clusterDomain</span>: <span style="color:#e6db74">&#34;cluster.local&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clusterDNS</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;10.96.0.10&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">authorization</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mode</span>: <span style="color:#ae81ff">Webhook</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">cgroupDriver</span>: <span style="color:#ae81ff">systemd</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">containerRuntimeEndpoint</span>: <span style="color:#e6db74">&#34;unix:///var/run/containerd/containerd.sock&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">resolvConf</span>: <span style="color:#e6db74">&#34;/etc/resolv.conf&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">runtimeRequestTimeout</span>: <span style="color:#e6db74">&#34;15m&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 两个节点的这个配置不一样，node01 是 10.244.1.0/24，node02 是 10.244.2.0/24</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">podCIDR</span>: <span style="color:#e6db74">&#34;10.244.1.0/24&#34;</span>
</span></span></code></pre></div><p>准备 kubelet 的 Systemd service 文件 <code>/etc/systemd/system/kubelet.service</code>，请注意 &ndash;node-ip 的参数，这个地方要分别改为 Node 的主 IP，我们这个实验当中分别是 56.11 和 56.12。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[Unit]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">Kubernetes Kubelet</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Documentation</span><span style="color:#f92672">=</span><span style="color:#e6db74">https://github.com/kubernetes/kubernetes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Service]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/usr/local/bin/kubelet --kubeconfig=/etc/kubernetes/admin.kubeconfig \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--node-ip</span><span style="color:#f92672">=</span><span style="color:#e6db74">192.168.56.11 \ # 这个地方要分别改为 Node 的主 IP，我们这个实验当中分别是 56.11 和 56.12</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--config</span><span style="color:#f92672">=</span><span style="color:#e6db74">/etc/kubernetes/kubelet.yaml \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">--v</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Restart</span><span style="color:#f92672">=</span><span style="color:#e6db74">on-failure</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RestartSec</span><span style="color:#f92672">=</span><span style="color:#e6db74">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Install]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">multi-user.target</span>
</span></span></code></pre></div><p>启动 kubelet，设置开机启动。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl start kubelet
</span></span><span style="display:flex;"><span>systemctl enable kubelet
</span></span></code></pre></div><p>到这里，Worker 的安装工作就结束了。</p>
<p>接下来我们为集群<a href="/cn/05-%e8%ae%be%e7%bd%ae%e7%bd%91%e7%bb%9c.md">设置网络</a>。</p>
<h2 id="五设置基本的路由网络">
  五、设置基本的路由网络
  <a class="anchor" href="#%e4%ba%94%e8%ae%be%e7%bd%ae%e5%9f%ba%e6%9c%ac%e7%9a%84%e8%b7%af%e7%94%b1%e7%bd%91%e7%bb%9c">#</a>
</h2>
<p>绝大多数场景下，Kubernetes 网络是倚靠网络插件来完成的，典型的插件包括 <code>flannel</code>，<code>calico</code>，<code>weaver</code> 等等。</p>
<p>为了演示基本的 Pod 网络，我们在这里先不使用上面的经典插件，通过自己设置路由来完成；网络插件的安装会在后面的章节补充。</p>
<p>如下图，每个 Node 都会有一个独立的 Pod 网段。在 Master 和 Node 节点，我们会手动加上到 Pod 的路由。</p>
<p><img src="/imgs/05-routes.png" alt="" /></p>
<h3 id="添加-cni-的配置">
  添加 CNI 的配置
  <a class="anchor" href="#%e6%b7%bb%e5%8a%a0-cni-%e7%9a%84%e9%85%8d%e7%bd%ae">#</a>
</h3>
<p>创建 CNI 的配置文件夹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /etc/cni/net.d/
</span></span></code></pre></div><p>创建子网的配置 <code>/etc/cni/net.d/10-bridge.conf</code>。两个 node 上的配置稍有区别：node01 上分配了 <code>10.244.1.0/24</code>，我们写成下面的样子；如果是 node02 的，就把 <code>subnet</code> 参数的网段配置改为 <code>10.244.2.0/24</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;cniVersion&#34;</span>: <span style="color:#e6db74">&#34;1.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;bridge-network&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;bridge&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;bridge&#34;</span>: <span style="color:#e6db74">&#34;cni0&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;isGateway&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;ipMasq&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;ipam&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;host-local&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;ranges&#34;</span>: [
</span></span><span style="display:flex;"><span>      [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;subnet&#34;</span>: <span style="color:#e6db74">&#34;10.244.1.0/24&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      ]
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;routes&#34;</span>: [
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;dst&#34;</span>: <span style="color:#e6db74">&#34;0.0.0.0/0&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>创建回环配置 <code>/etc/cni/net.d/99-loopback.conf</code>，两个 node 上的配置一样。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;cniVersion&#34;</span>: <span style="color:#e6db74">&#34;1.1.0&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;loopback&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;loopback&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="添加路由">
  添加路由
  <a class="anchor" href="#%e6%b7%bb%e5%8a%a0%e8%b7%af%e7%94%b1">#</a>
</h3>
<p>最后，在三台机器上分别设置路由。</p>
<p>master 上：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ip route add 10.244.1.0/24 via 192.168.56.11
</span></span><span style="display:flex;"><span>ip route add 10.244.2.0/24 via 192.168.56.12
</span></span></code></pre></div><p>node01 上：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ip route add 10.244.2.0/24 via 192.168.56.12
</span></span></code></pre></div><p>node02 上：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ip route add 10.244.1.0/24 via 192.168.56.11
</span></span></code></pre></div><p>接下来我们就可以<a href="/cn/06-%e8%bf%90%e8%a1%8cPod.md">运行 Pod</a>了。</p>
<h2 id="六运行-pod">
  六、运行 Pod
  <a class="anchor" href="#%e5%85%ad%e8%bf%90%e8%a1%8c-pod">#</a>
</h2>
<h3 id="运行-pod">
  运行 Pod
  <a class="anchor" href="#%e8%bf%90%e8%a1%8c-pod">#</a>
</h3>
<p>在 master 机器上，执行下面的命令，创建一个 Deployment。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create deployment nginx --image<span style="color:#f92672">=</span>nginx:latest
</span></span></code></pre></div><p>执行下面的命令查看 Pod 状态。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get pods -o wide
</span></span></code></pre></div><p>当 Status 变成了 Running，这个 Pod 就启动成功了，同时还能看到 Pod 的 IP 地址。</p>
<p>从 master 节点上可以尝试 ping 和 wget 这个 IP。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ping -c <span style="color:#ae81ff">2</span> &lt;POD_IP&gt;
</span></span><span style="display:flex;"><span>wget &lt;POD_IP&gt;
</span></span></code></pre></div><p>如果能 ping 通，wget 也能获取到 index.html 文件，说明网络正常。</p>
<h2 id="七安装-flannel-网络插件和-kube-proxy">
  七、安装 Flannel 网络插件和 kube-proxy
  <a class="anchor" href="#%e4%b8%83%e5%ae%89%e8%a3%85-flannel-%e7%bd%91%e7%bb%9c%e6%8f%92%e4%bb%b6%e5%92%8c-kube-proxy">#</a>
</h2>
<p>在前面的网络设置中我们使用系统间的路由表来做流量导向，这个方案可以在集群里访问 Pod 地址</p>
<p>这个章节我们来安装 Flannel，通过它实现 Pod 网络的联通。</p>
<p>并且还会介绍 kube-proxy 的安装，让集群支持 Service 网络。</p>
<h3 id="安装和-flannel">
  安装和 Flannel
  <a class="anchor" href="#%e5%ae%89%e8%a3%85%e5%92%8c-flannel">#</a>
</h3>
<p>首先在 Node 节点下载 flannel 的守护进程 <code>flanneld</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/flannel-io/flannel/releases/download/v0.25.7/flannel-v0.25.7-linux-amd64.tar.gz
</span></span></code></pre></div><p>解压，将里面的 <code>flanneld</code> 文件挪到 <code>/usr/local/bin</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xzvf flannel-v0.25.7-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>mv flanneld /usr/local/bin
</span></span></code></pre></div><p>然后还要安装 flannel 的 CNI 插件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/flannel-io/cni-plugin/releases/download/v1.5.1-flannel3/cni-plugin-flannel-linux-amd64-v1.5.1-flannel3.tgz
</span></span></code></pre></div><p>解压，将里面的 <code>flannel-amd64</code> 文件挪到 <code>/usr/local/bin</code> 并改名字。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar xzvf cni-plugin-flannel-linux-amd64-v1.5.1-flannel3.tgz
</span></span><span style="display:flex;"><span>mv flannel-amd64 /opt/cni/bin/flannel
</span></span></code></pre></div><h3 id="配置-flannel">
  配置 flannel
  <a class="anchor" href="#%e9%85%8d%e7%bd%ae-flannel">#</a>
</h3>
<p>切换成 flannel 之前，需要把我们前面配置的路由 CNI 配置清理掉。</p>
<blockquote>
<p>[!NOTE]</p>
<p>如果在前面创建了 Pod，在调整网络之前，需要把它们先都清理掉。否则会出问题。</p>
<p>可以执行 <code>kubectl delete deployment nginx</code> 将前面的 Pod 都删掉。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>rm -f /etc/cni/net.d/*
</span></span></code></pre></div><p>然后创建 <code>/etc/cni/net.d/10-flannel.conflist</code>，添加以下内容。这个配置文件是给容器 Runtime 看的，为的是告诉 Runtime 我们要用 flannel。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;cbr0&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;cniVersion&#34;</span>: <span style="color:#e6db74">&#34;0.3.1&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;plugins&#34;</span>: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;flannel&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;delegate&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;hairpinMode&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;isDefaultGateway&#34;</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;portmap&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;capabilities&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;portMappings&#34;</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>接下来准备一份给 flanneld 看的配置文件。创建 <code>/etc/kube-flannel/net-conf.json</code>，添加下面的内容，两个 Node 内容一样。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Network&#34;</span>: <span style="color:#e6db74">&#34;10.244.0.0/16&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;EnableNFTables&#34;</span>: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Backend&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;Type&#34;</span>: <span style="color:#e6db74">&#34;vxlan&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然后准备 flanneld 的 service 文件 <code>/etc/systemd/system/flanneld.service</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[Unit]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">Flannel</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Documentation</span><span style="color:#f92672">=</span><span style="color:#e6db74">https://github.com/flannel-io/flannel/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Service]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EnvironmentFile</span><span style="color:#f92672">=</span><span style="color:#e6db74">/etc/kubernetes/flanneld.env</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/usr/local/bin/flanneld $FLANNELD_ARGS</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Restart</span><span style="color:#f92672">=</span><span style="color:#e6db74">on-failure</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RestartSec</span><span style="color:#f92672">=</span><span style="color:#e6db74">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Install]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">multi-user.target</span>
</span></span></code></pre></div><p>并且还要准备启动的参数和环境变量。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">NODE_NAME</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;node01&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FLANNELD_ARGS</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-kube-subnet-mgr \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">-kubeconfig-file</span><span style="color:#f92672">=</span><span style="color:#e6db74">/etc/kubernetes/admin.kubeconfig \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">-ip-masq \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">-public-ip</span><span style="color:#f92672">=</span><span style="color:#e6db74">192.168.56.11 \</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">-iface</span><span style="color:#f92672">=</span><span style="color:#e6db74">eth1&#34;</span>
</span></span></code></pre></div><p>Flannel 可以独立运行，也可以作为 DaemonSet 以容器化方式运行。前者一般从 <code>etcd</code> 当中存储网络信息，后者一般通过 Kubernetes API 存储网络信息。但这里我们做了一些取巧：通过设置 NODE_NAME、kube-subnet-mgr、kubeconfig-file 等参数，让 flanneld 在独立运行的情况下也通过 Kubernetes API 存储网络信息。</p>
<p>这些配置参数当中 <code>NODE_NAME</code> 要根据具体的 node 进行修改，第一台就写 <code>node01</code>，第二台就写 <code>node02</code>；另外 public-ip 也要做相应调整，分别改成主要用来互联的那个 IP。</p>
<p>改完了 <code>flanneld</code> 的相关配置文件，我们还要去 <code>kube-controller-manager</code> 那边做一点调整。</p>
<p>在第 5 篇，我们是自己在每台 Node 上面安排了网段：Node01 用 10.224.1.0/24，Node02 用 10.224.2.0/24，使用了 flannel 之后，给 Node 分配网段的任务就可以交给 K8s 集群了。</p>
<p>在 master 的 kube-controller-manager 启动配置中，添加一条参数</p>
<pre tabindex="0"><code>KUBE_CONTROLLER_MANAGER_ARGS=&#34;... \
... \
--allocate-node-cidrs \
...
</code></pre><p>这句话的意思是，各个 Node 的网段由 <code>kube-controller-manager</code> 来分配。</p>
<p>保存，在 master 上重启 <code>kube-controller-manager</code>，并且在 node 上重启 <code>flanneld</code>。</p>
<h3 id="安装-kube-proxy">
  安装 kube-proxy
  <a class="anchor" href="#%e5%ae%89%e8%a3%85-kube-proxy">#</a>
</h3>
<p>[TODO]</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
  </main>

  
</body>
</html>












